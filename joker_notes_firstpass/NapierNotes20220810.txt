Napier: 08/10/2022

- Goals: Refit RNN, effect of noise training, broadband recording
 
- Experimenters: Joey, Hisham

- Recording Start Time: 9:30 am
- Recording Stop Time:  11:50 am

- xPC Model: Rig_main_Cortical_Parasite_v2
- Recorded Array: Motor (Patient cable/cerebus)
- Data recorded: Spikes (250Hz highpass, RMS -4.5) + 2kSps 300-1000HzBPas continuous + broadband
- Drink: Apple Juice

- Params: 
	* Movement Mask: [0,1,0,1,0]
	* Target Hold Time (OL/CL): 750/500
	* Target Scaling(OL/CL): 100
	* Juice Time: 100
	* Trial Timeout: 10000
	* Auto Juice: 0
   	* Target Pos Style (OL/CL): 29
	* Visualization Style: MRP
	
-Decoders:	
	- all decoders trained with tri vel redistribution, RR scaler, RNNs with *20* time history
	RNN0 - GRU without norm					(0.71/0.79)
	RNN1 - GRU with full X norm 			(0.75/0.79)
	RNN2 - GRU refit run 9					(~0.6 correlation)
	RNN3 - GRU refit run 12					(0.6/0.69)
	RNN4 - GRU with full X norm + noise		(0.75/0.79)
	
	center out:
	RNN5 - GRU with full X norm + noise 	(0.69/0.69)

	For refence (not used):
	KF0 : TrainOnline_Cortical_KalmanFilter_Multi('Joker','',3,false,[2 4],32,0,good_chans_SBP,good_chans_SBP,1,{'act_thresh',1},0,true); 

	
-Runs:
	Run 1: calibration
	Run 2: warmup - 300 trials. 2 min break.
	Run 3: TS29 training - 500 trials. BR~4.3  #HC1#.
	-- 10min training break --
	
GH1 = gradual hand control to decoder over 1 min
	
	Run 4-6: debug, ignore
	Run 7: RNN0, GH1 - got stuck at flex at 62 sec. unable to recover.
	Run 8: RNN1, GH1 - No norm adjustment. Having some trouble, but its working. Working pretty well trial 70-200 with a couple brief stuck. Very fast and able to stop, but hard to fine adjust. Crash trial 113. 
	Run 9: RNN1, immediate online, no norm adjustment. Working at trial 25, pretty good trial 40. Index extend is slow. Getting the hang of it trial 100 (200 sec). Trial 170-200+ is pretty clean/fast. Crashed at trial 260. Last 100 BR~2.3
	Run 10: RNN1, GH1 - 2 min ema norm, locked at 1min. Crash trial 54. (kinda working, still figuring it out)
	Run 11: RNN1, GH30sec - 2 min ema norm, locked at 30sec. working well trial 30, index extend is slow. Very good at trial 70 (150sec). Crash trial 90
	(reduced parasite history to 5 bins, instead of 20)
	Run 12: RNN1, GH30sec - 2 min ema norm, locked at 30sec. working at trial 30, having some trouble on splits. Working good for a few trials, then somewhat stuck, repeat. BR~1.9. 320 trials. Looking good at 240-310 (BR~2.3)
	
	Run 13: RNN2 (refit), GH30sec - No norm adjustment. Stuck at extension, not working.
	Run 14: RNN3 (refit), GH30sec - 2 min ema norm, locked at 30sec. Biased toward extension, not working. 
	
With/without noise training:
	Run 15: RNN4, GH30sec - No norm adjustment. Working really well from start (trial 25). Maybe slightly too fast. Really good trial 100- without any problems. Some overshooting, but very fast and controlled. BR~2.4-2.5. Crash at 260.
	Run 16: RNN4, GH30sec - 2 min ema norm, locked at 30sec. Slower than run15 and having some trouble with splits. (but looks less "slippery"). Looks worse than run 15. 100 trials. BR~2.2
	Run 17: RNN1, GH30sec - No norm adjustment. Initially having some trouble, working trial 30. Working pretty well. 130 trials. BR~2.3
	Run 18: RNN4, GH30sec - No norm adjustment. Working right away. Working well, some overshooting. 130 trials. BR~2.55
	
Center-out: (about 100 minutes into the experiment here)
	Run 19: TS34 training - 500 trials. BR~4.8. (looks more controlled/less adjustments that the TS29 training)
	-- 5min training break --
	Run 20: TS34 - RNN5, GH30sec - No norm adjustment. Pretty controlled and smooth. slightly slower than RNN4. some orbiting. 200 trials. BR~2.4
	Run 21: TS34 - RNN4, GH30sec - No norm adjustment. Working well from start, but considerable overshooting. Crash at trial 175. BR~2.3
	Run 22: TS29 - RNN5, GH30sec - No norm adjustment. Slower, more controlled, less overshooting than RNN4. Stopped at trial 109. BR~2.2. Ran out of juice	




Summary:
	RNNs are running consistently:
		- **training with noise helps a little - when switching to online it works immediately
		- training with 20 history seems more stable than the 5 we used before
		- parasite seems to be crashing occasionally, maybe due to storing long neural history
		- **no need to do neural norm adjustment
		
		- get about 2.4-2.5 bitrate consistently without refit
		
TODO:
	- refit code still doesn't seem correct. The example decodes during training didn't seem very good.
	- unclear if gradual hand control is helpful

	
	
-Notes:	
	From 8/3/22:
	good_chans_SBP = [1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 12, 13, 15, 17, 20, 23, 24, 33, 35, 37, 38, 39, 40, 42, 43, 45, 46, 47, 49, 50, 51, 52, 53, 55, 56, 57, 58, 59, 60, 61, 62, 64, 65, 67, 68, 69, 71, 72, 73, 74, 75, 76, 78, 81, 82, 83, 84, 85, 86, 87, 88, 90, 91, 92, 93, 94, 96]


	
