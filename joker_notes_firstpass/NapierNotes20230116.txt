Napier: 1/16/2023

- Goals: KalmanNet debugging
 
- Experimenters: Luis, Hisham

- Recording Start Time: 11:00am
- Recording Stop Time:   am

- xPC Model: Rig_main_Cortical_Parasite_v2
- Recorded Array: Motor (Patient cable/cerebus)
- Data recorded: Spikes (250Hz highpass, RMS -4.5) + 2kSps 300-1000HzBPas continuous 
- Drink: Apple Juice

- Params: 
	* Movement Mask: [0,1,0,1,0]
	* Target Hold Time (OL/CL): 750/500
	* Target Scaling(OL/CL): 100
	* Juice Time: 80
	* Trial Timeout: 5000
	* Auto Juice: 0
   	* Target Pos Style (OL/CL): 29, 35
	* Visualization Style: MRP
	
-Decoders:
	KF0: TrainOnline_Cortical_KalmanFilter_Multi('Joker','2023-01-16',3,false,[2,4],50,0,good_chans_SBP,good_chans_SBP,1,{'act_thresh',1},0,true);
		SBP KF correlation = 0.79879
		SBP KF lag = 1
	KFN0: regular KF through KalmanNet trained on run 3.
		[0.67, 0.92, 0.36, 0.60], lag 0
		- Had put the wrong binsize, had it hardcoded
	KFN1: regular KF through KalmanNet trained on run 3
		[0.67, 0.91, 0.36, 0. 60], lag 0
	
	KF1: training on the 12 good channels given by the KalmanNet training, to see if that's what's causing the issue.
		good_chans = [4,7,8,65,67,71,72,73,75,77,82,84]
		SBP KF correlation = 0.76774
		SBP KF lag = 1
	KFN5: training on 75 channels, on run 3. Seeing whether the number of channels was causing the issue.
		[0.77, 0.92, 0.47, 0.64] offline, lag 1


-Runs:
	Run 1: Calibration
	Run 2: TS29 270 trials. Stopped it because I changed the calibration for extension for MRS, he was having trouble with those targets.
	Run 3: TS29 500 trials.
	Run 4: TS29 KF0 200 trials. Very biased towards flexion. Can't do any extension trials. After a while, it fixed itself. Movement looks jumpy but pretty good. Bitrate at ~1.5. Got to 1.75 at the end
	Run 5: TS29 KFN0. Completely stuck in the middle when beta=1. That would mean that the decoder would be completely driven by velocity. Setting beta=0.95 doesn't help much, as it the velocity is forcing the fingers to the middle. When I set the beta=0, the position is really jumpy, and it doesn't move much from the middle. Setting beta=1 and scaling the velocity by bin size caused the fingers to bias. There's definitely something wrong with the velocities, but I don't think it's the scale anymore.
	Run 6: TS29 KFN1. With beta=1 and no velocity scaling, it doesn't move at all, the fingers stay in the center. With beta=0.8 it kinda works, but still can't manage most targets.
	Run 7: TS29 KF1. Very biased at the beginning. Index gets very biased towards extension, MRS stays in the middle. Napier can't complete trials like this.
	Run 8: TS29 KFN5. Even though I'm using 75 channels, the filter does not move. It has to do with the output of the velocity, but no idea what it is.
	Run 9: TS29 KFN5. Have more prints to debug.
	Run 10: TS29 KF0. Trying to see the scale of the output. It doesn't work. It is very biased towards extension, and it can only do a small amount of targets.Tried it for 50 trials before shutting it down. It didn't get better. Forgot to set the good channels back to the 75 original, so it's not very valid.

Summary:
	- Managed to confirm that there are issues with the velocity output from the model.
	- The channels selected also impact the results somewhat: I tried the lab-trained KF with the 12 channels I use for KalmanNet and it didn't work.


TODO:
	- Check and recheck how I run my stuff online and see what is different to the lab-made KF.


Notes:
	- For some reason, the kalmannet model for the regular KF with 75 channels is huge in size, over 3GB. I'm probably saving something very heavy with the model. Fixed.
	
	good_chans_SBP = [1, 3, 4, 5, 7, 8, 9, 11, 14, 15, 17, 20, 22, 23, 24, 25, 26, 28, 29, 31, 33, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 71, 72, 73, 74, 75, 76, 78, 81, 82, 83, 84, 85, 86, 87, 88, 90, 91, 92, 94, 96];
	
	
	


