Napier: 11/30/2022

- Goals: KNet and refit
 
- Experimenters: Luis, Mender

- Recording Start Time: 8:50 am
- Recording Stop Time: 11:40 am

- xPC Model: Rig_main_Cortical_Parasite_v2
- Recorded Array: Motor (Patient cable/cerebus)
- Data recorded: Spikes (250Hz highpass, RMS -4.5) + 2kSps 300-1000HzBPas continuous
- Drink: Apple Juice

- Params: 
	* Movement Mask: [0,1,0,1,0]
	* Target Hold Time (OL/CL): 750/500
	* Target Scaling(OL/CL): 100
	* Juice Time: 90
	* Trial Timeout: 5000
	* Auto Juice: 0
   	* Target Pos Style (OL/CL): 34/29
	* Visualization Style: MRP
	
-Decoders:	**50ms bins today**
	- all decoders trained with parameters from run floral-firefly-957 from wandb
	KFN0: regular KF
		[0.76,0.82,0.41,0.55]
	KNet0: Knet with linear model trained on TS34
		[0.73, 0.78, 0.60, 0.69]
	KNet1: KNet with non linear model trained on TS34
		[0.75,0.81,0.62,0.70]
	KNet2: KNet with linear model trained on TS29
		[0.87, 0.81, 0.66, 0.66]
	KNet3: KNet with non linear model trained on TS29
		[0.88, 0.82, 0.68, 0.63]
	RKFN0: Regular KF refit on run 14
	Knet4: Knet with non linear model trained on TS29 without scaled loss
		[0.82, 0.85, 0.35, 0.54]

-Runs:
	Run 1: calibration
	Run 2: 402 TS34 hand control trials.
	Run 3: 400 TS29 hand control trials. MRS very jittery, and there was some drift of the value of the MRS flex sensor that caused it to be hard for Napier to reach the extension targets.
	-- KFN0 beta=1
	Run 4: 231 TS34. Didn't move at all. Had to change the beta to 0.9 and now it moves a little bit at least. Bitrate at ~1.4
	-- KNet0 linear model beta=0.9 and 0.8
	Run 5: TS34. Didn't work with either beta. The MRS was completely biased towards extension, the index was biased towards flexion, and none of them were moving.
	-- KNet0 linear, beta=0.5
	Run 6: TS34. one more try with stuff from previous run, to see if it is an initialization issue. Nope, didn't work.
	-- KNet1 non linear, beta=0.9
	Run 7: TS34. MRS completely biased towards extension. Index was moving a little bit. Manually adding some bias to the predicted positions helped, but didn't completely solve the problem. Also, the velocities are just too small. 
	Run 8: 300 TS34. I'll add the manual bias and also will multiply the speeds by a constant, starting with 5. It kinda works, but gets biased fast when using beta=1 too. Doesn't work with lower betas. The position is too noisy, and thus is creating problems for everything else. A lot of hand control trials are interleaved.
	-- KNet2 linear trained on TS29
	Run 9: TS29 and TS34. Tried with multiple combinations of biases and velocity multiplications, but to no avail. It crashed and I restarted.
	Run 10: Same as above, restarting the previous run
	-- KNet3 nonlinear trained on TS29
	Run 11: TS29. Not working. Crashed. 
	Run 12: TS34, not working either. 
	
	-- KFN0 beta=1, vel multiplier = multiples
	Run 13: TS34. Will try multiple velocity multipliers, so that it works on velocity only control. The best velocity scaler was 32, so there has to be something wrong on how I'm computing the A matrix. I still need a beta=0.98 for it to work and not get biased, but it works pretty fast at least. Will do a run of only that with TS29.
	Run 14: TS29 beta=0.98, multiplier=32. Bitrate around 1.6, and seems to work pretty good. I will do refit with this run. Having issues with the index extension targets.
	Run 15: TS29, bet=0.98, multiplier=32. Worked for a few trials at the beginning, and then the fingers got kinda stuck for a long time. After a while, it started working again, but it is pretty slow. Maybe it was just Napier not wanting to do the trials. Avg. bitrate ~1.2. It seems that Napier doesn't want to hit the further out trials. Had to stop it due to lack of effort.
	
	-- KNet3 nonlinear trained on TS29, now with binsize=32
	Run 16: TS29. Didn't work, tried a few bias corrections and velocity multipliers, but nothing worked. At least I can't blame not using the correct bin size.
	
	-- I'm training one more model but without the scaled loss, to see if that helps the performance online
	--KNet 4 non linear trained on TS29, no scaled loss
	Run 17: TS34 and TS29. Did not work, even when modifying beta, velocity multiplier and bias.
	


Summary:
	- Kalmannet worked very badly across all tests, mostly because the positions were very bad decoded, for some unknown reason. Need to figure that out.
	- The kalman filter worked great, but the refit kalman filter not so much. I had to scale the velocity for the KF to work correctly, and use a beta=0.98.
	

TODO:
	- The decoded velocities are too small. Need to upscale them somehow

	
Notes:
	good_chans_SBP = [1, 2, 3, 4, 5, 7, 8, 9, 11, 14, 15, 17, 20, 22, 23, 24, 25, 26, 28, 29, 31, 33, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 71, 72, 73, 74, 75, 76, 78, 81, 82, 83, 84, 85, 86, 87, 88, 90, 91, 92, 94, 96];
	-- I actually only used the following 12 for everything:
	The MRS sensor was very jittery, and varied over the time of the experiment. Napier had a very hard time reaching the far extension targets.
	I think that the scale of velocities is wrong somehow
	I don't know why the position decodes are so wrong. I think that is throwing off the full performance.
	
	Didn't realize that the bin size was an argument, and was running with binsize = 50 until run 13.


	












