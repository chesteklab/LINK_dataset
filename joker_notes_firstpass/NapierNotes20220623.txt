Napier: 06/23/2022

- Goals: RNN/FNN with EMA normalization, perturbation dataset, long broadband recording
 
- Experimenters: Joey, Mender

- Recording Start Time: 9:00 am
- Recording Stop Time:  11:30 am

- xPC Model: Rig_main_Cortical_Parasite_Purturbation
- Recorded Array: Motor (Patient Cable)
- Data recorded: Spikes (250Hz highpass, RMS -4.5) + 2kSps 300-1000HzBPas continuous + broadband
- Drink: Apple Juice

- Params: 
	* Movement Mask: [0,1,0,1,0]
	* Target Hold Time (OL/CL): 750/500
	* Target Scaling(OL/CL): 100
	* Juice Time: 100
	* Trial Timeout: 10000
	* Auto Juice: 0
   	* Target Pos Style (OL/CL): 29
	* Visualization Style: MRP
	
-Decoders:	
	- all decoders trained with tri vel redistribution, RR scaler, RNNs with 5 time history
	NN0 - willsey net, 3500 iters, 1 min neural norm
	RNN0 - GRU with 1 min neural norm
	RNN1 - GRU with 1 min neural norm (trained on run 15) - lower correlations 0.5/0.6
	NN1 - willsey net, 3500 iters, 1 min neural norm (trained on run 15) - lower correlations 0.5/0.6
	NN2 - willsey net, 3500 iters, NO neural norm (trained on run 15)
	RNN1 - GRU no norm (trained on run 15)
	RNN1 - GRU constant neural norm, y constant norm (trained on run 15)
	RNN1 - GRU constant neural norm (no y norm) (trained on run 15)

	KF0: TrainOnline_Cortical_KalmanFilter_Multi('Joker','',15,false,[2 4],32,0,good_chans_SBP,good_chans_SBP,1,{'act_thresh',1},0,true); (optimal lag [1, 1] - 0 lag picked) - 0.78 CC
	
	
-Runs:
	Tested references and measured impedance (a few super high impedances)
	Run 1: calibration
	Run 2: warmup - 50 trials.
	Run 3: TS29 training - 500 trials. BR~3.8-4.3 (slightly slow)  #HC1#. Fingers seem visibly slower on extension
	--- 10 min training break ---
	
	Run 4: wrong bin size
	Run 5: fnn 5min ema norm.
	Run 6: fnn 1min ema norm. fingers stuck, not moving
	Run 7: rnn 5min ema norm. Started in brain control. had to do hand control to get started. Fingers somewhat slow, hard to move long distances.
	After fingers are stuck, if you turn screen off/on it's like he tries again and moves it fast for one trial, then stuck again
	Run 8: rnn 5min ema norm. Started with 10 hand control. Fingers immediately biased at flex. Then screen off/on - worked for 2 trials (tr17-18ish), then biased. 
	50 hand control. Switch to brain, won't move, biased.
	Run 9: rnn 1min ema norm. Started with 10 hand control. Worked for a few trials until one finger was slightly stuck, then everything stopped working. MRP having trouble.
	50 hand control. Worked for one trial kinda, then biased at flex. 
	Run 10: rnn 30sec ema norm. Started with 10 hand control. Working better than before, but MRP still getting stuck toward flex (almost like the distribution shift is in the MRP subspace). Figured it out around trial 30-40, then stuck.
	Run 11 (or 12?): rnn 1min ema norm. Started with 30 hand control *with perturbations*. Then decoder stuck, not moving
	Run 13-14: debug
	
	Run 15: TS29 training - 500 trials. (Both 
	-- 5 min training break --
	Run 16: rnn1 1min ema norm. Started with 10 hand control. Decoder not working (but he was trying). 
	Run 17: KF0 (no normalization). Working pretty, but some oscillations, trouble stopping. 
	Run 18: fnn2 (no normalization). Working well.
	Run 19: rnn2 (no normalization). Biased immediately. 
	Run 20: rnn3 (trained with norm, 5ema online). Gain way off).
	Run 21: rnn4, ema 5min. biased.
	filelogger crashed
	Run 22 (not saved): rnn4, online rolling norm (old method). Biased toward flex. Not working even with switching between online/offline.
	
	filelogger restarted
	
	Perturbation datasets:
	Run 22: TS5 - 1d finger flapping (fingers not locked together). 500 trials. Start at trial 80. Perturbations 0.5 of trials. Seems like the perturbs while moving aren't very noticeable.
	Run 23: TS34 - 2d center out. 900 trials (then juice ran out), start at trial 20. Perturbations 0.5 of trials. 
	** remember to remove juicer artifact if using these datasets **
	
	
TODO:
	- LSTM crashing during training

 
	
-Notes:
	Wondering if juicer artifact is messing up the networks?


	good_chans_SBP = [1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 13, 15, 17, 23, 24, 33, 35, 37, 38, 39, 40, 43, 45, 46, 47, 49, 50,
					51, 52, 53, 55, 56, 57, 58, 59, 60, 62, 64, 65, 67, 68, 69, 71, 72, 73, 74, 75, 76, 78, 79,
					80, 81, 82, 83, 84, 85, 86, 87, 88, 90, 91, 92, 95, 96]
					
	good_chans_SBP = [1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 13, 15, 17, 23, 24, 33, 35, 37, 38, 39, 40, 43, 45, 46, 47, 49, 50,51, 52, 53, 55, 56, 57, 58, 59, 60, 62, 64, 65, 67, 68, 69, 71, 72, 73, 74, 75, 76, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 90, 91, 92, 95, 96]


	Tried the different patient cable references:
	- Ref C (what it was before) and Ref A appeared to have similar noise levels
	- Ref B had visibly higher noise
	- chose Ref A for today
	
	Signficant juicer artifact present
	
