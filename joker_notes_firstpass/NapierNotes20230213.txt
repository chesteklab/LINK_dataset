Napier: 2/13/2023

- Goals: KalmanNet
 
- Experimenters: Luis, Julianna

- Recording Start Time: 9:40 am
- Recording Stop Time:   am

- xPC Model: Rig_main_Cortical_Parasite_v2
- Recorded Array: Motor (Patient cable/cerebus)
- Data recorded: Spikes (250Hz highpass, RMS -4.5) + 2kSps 300-1000HzBPass + EMG 10ksps
- Drink: Apple Juice

- Params: 
	* Movement Mask: [0,1,0,0,0]
	* Target Hold Time (OL/CL): 750/500
	* Target Scaling(OL/CL): 100
	* Juice Time: 80
	* Trial Timeout: 5000
	* Auto Juice: 0
   	* Target Pos Style (OL/CL): 29, 35, 37
	* Visualization Style: MRP
	
-Decoders:
	- KF0: TrainOnline_Cortical_KalmanFilter_Multi('Joker','2023-02-13',2,false,[2 4],50,0,good_chans_SBP,good_chans_SBP,1,{'act_thresh',1},0,true)
		SBP KF correlation = 0.72138
		SBP KF lag = 1
	- KFN0: regular KF through KalmanNet. Trained on same channels as KF0, with run 2.
		[0.73, 0.75, 0.42, 0.53]
	- KFN1: regular KF through KalmanNet. Trained on 12 channels selected iteratively, with run 2.
		[0.63, 0.71, 0.36, 0.51]
	- KNet0: KalmanNet, linear model, LSTM, 250 iterations, trained on run 3.
		[0.79, 0.81, 0.66, 0.64]
	- KNet1: KalmanNet, linear model, LSTM, 250 iterations, trained on run 3, with 'tri' velocity redistribution. Hadn't tried this before, so I could have run it wrong.
		[0.39, 0.52, 0.26, 0.20]
	- KNet2: Same as KNet0 but trained on run 4.
		[ 0.66, 0.75, 0.76, 0.70]
		
	
-Runs:	
	Run 1: calibration
	Run 2: 500 TS29 hand control. Bitrate ~4
	Run 3: 500 TS37 hand control. Bitrate ~3
	Run 4: 500 TS35 hand control. Bitrate ~4
	-- KF0
	Run 5: 25 TS29. Got a little biased at the beginning, but then it recovered. Hadn't loaded the KF parameters.
	Run 6: 150 TS29. Index is biased towards extension. The partial hand control kicked in (at 0.95) and it helped Napier start doing the trials. Had to enable it again in the middle, as the decoder is not doing very well. Bitrate at 0.8, even counting the trials that he had partial hand control. He's oscillating a lot, and the index tends to get biased towards extension.
	-- KFN0
	Run 7: 170 TS29. Fingers completely biased towards flexion. Tried increasing the partial hand control little by little, but the bias pulls too much. Restarted it a couple of times, but didn't help.
	-- KFN1
	Run 8: TS29. Fingers are very biased towards extension, and can't seem to get out. Sometimes when I initialize it, it manages, but most of the time it doesn't. Did 200 trials alternating different decoders and trying different things.
	-- KNet0
	Run 9: 176 TS29 beta=1.0. At trial 100 I have 0 partial hand control. Before, I was using some of it, progressively increasing it. The index tends to get biased towards extension. Had to use partial hand control again. Trial 157 started with pure decoder again. Can't do any trials after that: index is completley biased towards extension. Crashed
	Run 10: TS29. Similar behavior. Can't do any trials on his own.
	-- KNet1
	Run 11: TS29, beta=1. Doesn't seem to work on its own. MRS is biased towards flexion. Index can move around a little more. Crashed
	Run 12: TS29, beta=1. Fingers move really really slowly, and don't seem to be moving to the targets.
	-- KNet2
	Run 13: TS29, beta=1. Started very well, doing trials fast. Then, index got biased towards flexion, and MRS towards extension. Crashed.
	Run 14: TS29, beta=1. Started doing them, stopped after like 5 successful trials. Crashed.
	Run 15: TS35, beta=1. Managed to do some trials. I think this was one of the best performing decoders, other than the regular KF. After trial 115, it got biased.
	-- KNet0
	Run 16: TS35, beta=1. Wasn't doing trials. Crashed.
	Run 17: TS35, beta=1. Did a few trials with partial hand control, but he doesn't seem to be able to control the virtual index. Crashed.
	-- KF0
	Run 18: TS29. Completely biased towards extension for both fingers. Tried doing partial hand control and it works for MRS, but not for index. We're done.
	
	
	
	
Summary:
	- 


TODO:
	- Implement logic to save the model at the iteration where it got the best performance for KalmanNet.

Notes:
	- good_chans_SBP = [1, 3, 4, 5, 7, 8, 9, 11, 14, 15, 17, 20, 22, 23, 24, 25, 26, 28, 29, 31, 33, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 71, 72, 73, 74, 75, 76, 78, 79, 81, 82, 83, 84, 85, 86, 87, 90, 91, 92, 94, 96];
	- Channels 5 and 7 of EMG seem to be only noise.
	- The regular KF was performing very badly.
	- The A matrix between the rig and my KF look very similar. C matrices look similar at a glance as well: similar scales and same
	
	
	



